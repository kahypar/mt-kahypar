/*******************************************************************************
 * MIT License
 *
 * This file is part of Mt-KaHyPar.
 *
 * Copyright (C) 2019 Tobias Heuer <tobias.heuer@kit.edu>
 * Copyright (C) 2025 Nikolai Maas <nikolai.maas@kit.edu>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 ******************************************************************************/

#include "gtest/gtest.h"

#include <vector>
#include <unordered_map>
#include <unordered_set>
#include <set>
#include <string>
#include <fstream>
#include <sstream>

#include <CLI/CLI.hpp>

#include "mt-kahypar/partition/context.h"
#include "mt-kahypar/io/command_line_options.h"
#include "mt-kahypar/io/presets.h"

using ::testing::Test;

#define MT_KAHYPAR_CONFIG_DIR "@PROJECT_SOURCE_DIR@/config/"

namespace mt_kahypar {

void comparePresetWithIniFile(PresetType preset, std::string ini_filename) {
  Context dummy_context;
  std::vector<CLI::ConfigItem> ini_list = CLI::ConfigINI().from_file(ini_filename);
  std::vector<std::string> preset_list = loadPreset(preset);

  std::unordered_map<std::string, std::string> ini_mapping;
  for (const auto& item: ini_list)  {
    ASSERT_EQ(ini_mapping.find(item.name), ini_mapping.end());
    std::string& value = ini_mapping[item.name];
    for (auto& v: item.inputs) {
      value += v;
    }
  }

  std::unordered_map<std::string, std::string> preset_mapping;
  for (const std::string& entry: preset_list) {
    std::stringstream ss(entry);
    std::string name;
    std::string value;
    char del = '=';
    std::getline(ss, name, del);
    std::getline(ss, value, del);
    ASSERT_TRUE(name.size() > 2 && name[0] == '-' && name[1] == '-');
    name = name.substr(2);
    ASSERT_TRUE(value.size() == 1 || preset_mapping.find(name) == preset_mapping.end());
    preset_mapping[name] += value;
  }

  for (const auto& [name, value]: preset_mapping) {
    if (ini_mapping.find(name) == ini_mapping.end()) {
      LOG << "Missing value in config file:" << name;
    }
    ASSERT_TRUE(ini_mapping.find(name) != ini_mapping.end());
    ASSERT_EQ(value, ini_mapping[name]);
  }
  for (const auto& [name, _]: ini_mapping) {
    if (preset_mapping.find(name) == preset_mapping.end()) {
      LOG << "Missing value in preset function:" << name;
    }
    ASSERT_TRUE(preset_mapping.find(name) != preset_mapping.end());
  }

  // check whether an error occurs during actual parsing
  Context c1;
  parseIniToContext(c1, ini_filename, false);
  Context c2;
  presetToContext(c2, preset, false);
}

TEST(AContext, LoadsDefaultPresetCorrectly) {
  comparePresetWithIniFile(PresetType::default_preset, std::string(MT_KAHYPAR_CONFIG_DIR) + "default_preset.ini");
}

TEST(AContext, LoadsQualityPresetCorrectly) {
  comparePresetWithIniFile(PresetType::quality, std::string(MT_KAHYPAR_CONFIG_DIR) + "quality_preset.ini");
}

TEST(AContext, LoadsDeterministicPresetCorrectly) {
  comparePresetWithIniFile(PresetType::deterministic, std::string(MT_KAHYPAR_CONFIG_DIR) + "deterministic_preset.ini");
}

TEST(AContext, LoadsDeterministicQualityPresetCorrectly) {
  comparePresetWithIniFile(PresetType::deterministic_quality, std::string(MT_KAHYPAR_CONFIG_DIR) + "deterministic_quality_preset.ini");
}

#ifdef KAHYPAR_ENABLE_HIGHEST_QUALITY_FEATURES
TEST(AContext, LoadsHighestQualityPresetCorrectly) {
  comparePresetWithIniFile(PresetType::highest_quality, std::string(MT_KAHYPAR_CONFIG_DIR) + "highest_quality_preset.ini");
}
#endif

#ifdef KAHYPAR_ENABLE_LARGE_K_PARTITIONING_FEATURES
TEST(AContext, LoadsLargeKPresetCorrectly) {
  comparePresetWithIniFile(PresetType::large_k, std::string(MT_KAHYPAR_CONFIG_DIR) + "large_k_preset.ini");
}
#endif

}  // namespace mt_kahypar
